@(title: String, q: uk.bl.wa.shine.Query, currentPage: uk.bl.wa.shine.Pagination, currentSortBy: String, currentOrder: String, facetLimit: Int, optionalFacets: Map[String, uk.bl.wa.shine.model.FacetValue], cachedFacets: Map[String, uk.bl.wa.shine.model.FacetValue])

@styles = {
	<link rel="stylesheet" type="text/css" media="screen" href="@routes.Assets.at("stylesheets/jquery-ui/jquery-ui-1.10.4.custom.min.css")">
	<link rel="stylesheet" type="text/css" media="screen" href="@routes.Assets.at("bootstrap/typeahead/css/typeahead.css")">
}

@scripts = {
	<script src="@routes.Assets.at("javascripts/search.js")" type="text/javascript"></script>
	
	<script type="text/javascript">
		$(document).ready(function() {

			$('#sort').val('@(currentSortBy)')
	  		$('#order').val('@(currentOrder)')

	  		// if facet.show=crawl_year
	  		var facetShow = getURLParameter("facet.show");
	  		if (facetShow) {
				var array = facetShow.split(",");
				array.forEach(function(value) {
					var link = 'a#' + value;
					console.log(">>> " + link);
					$(link).trigger("click");
				});
	  			
	  		}
	  		
			$('#ajax-loader').hide();

			function disableForm() {
				$('#ajax-loader').show();
				$('#query').attr('disabled', 'disabled');
				$('#search').attr('disabled', 'disabled');
				$('#reset').attr('disabled', 'disabled');
			}
			
			function enableForm() {
				$('#ajax-loader').hide();
				$('#query').removeAttr('disabled');
				$('#search').removeAttr('disabled');
				$('#reset').removeAttr('disabled');
			}

			function getUrl() {
				return "/ajaxSearch?query=" + $("#query").val() + "&start=0&rows=10";
			}
			
			$('#search').on('click', function(event) {
				event.preventDefault();
				//$('form').submit();
				processSearch();
			});
			
			paging();
			
			function paging() {
				$('.paging').each(function() {
					var $link = $(this);
					// build up a next page ref via ajax
	//				$link.attr('href', '#');
					$link.on('click', function(event) {
						event.preventDefault();
						var page = $link.attr('id').split('-')[1];
						console.log(page + " " + $link.attr('href'));
						processSearch(page)
						// remove all classes from list
						removeActive();
	 					$link.parent().attr("class", "active current");
					});
				});
			}
			
			function removeActive() {
				$('.paging').each(function() {
					$(this).parent().removeAttr('class');
				});

			}
			
			function clearPager() {
	    		$('.pagination').each(function() {
	    			$(this).empty();
	    		});
			}
			
			function processSearch(page) {
				console.log(page);
				
				disableForm();
				
				var url = getUrl();
				
				if (page === undefined) {
					url += "&page=1";
				} else {
					url += "&page="+page;
				}
				
				//&sort=crawl_date+asc
				 //"&facet=true&facet.mincount=1"
				 //&facet.field=%7B%21ex%3Dcrawl_year%7Dcrawl_year
				 //&facet.field=%7B%21ex%3Dpublic_suffix%7Dpublic_suffix
				 //&facet.sort=index
				//	[{"query":"nhs","data":[{"value":"1994","count":3},{"value":"1995","count":1},{"value":"1996","count":439},{"value":"1997","count":2529},{"value":"1998","count":2792},{"value":"1999","count":7345},{"value":"2000","count":9946},{"value":"2001","count":36838},{"value":"2002","count":97371},{"value":"2003","count":236514},{"value":"2004","count":277319},{"value":"2005","count":207931}]},{"query":" wikipedia","data":[{"value":"2001","count":12},{"value":"2002","count":67},{"value":"2003","count":464},{"value":"2004","count":8030},{"value":"2005","count":64540}]}]
				$.ajax({
	    	    	url: url,
	    	    	dataType: 'json',
	    	    	success: function(data) {
	    	    		var results = [];
	    	    		$('#result-set').empty();
	    	    		$.each( data.results, function( index, obj ) {
		    	    		$listGroup = $('<div>').addClass('list-group');
		    	    		$spanGroup = $('<span>').addClass('list-group-item').attr('href', '#')
		    	    			.append('<span>').addClass('list-group-item').attr('href', '#');
		    	    		
		    	    		var title = obj.title;
		    	    		if (obj.title == '') {
		    	    			title = "no title";
		    	    		}
		    	    			
		    	    		$heading = $('<h4>').addClass('list-group-item-heading').html("<a href='" + obj.url + "'>" + title + "</a>");
		    	    		$paragraph = $('<p>').addClass('list-group-item-text');
		    	    		var paraData = obj.crawl_date + "<br />" + obj.content_type_norm + "<br />" + obj.domain + "<br />" + obj.sentiment_score;
		    	    		$paragraph.html(paraData);
							$spanGroup.append($heading);
							$spanGroup.append($paragraph);
		    	    		$listGroup.append($spanGroup);
		    	    		$('#result-set').append($listGroup);
		    	    		query = $('#query').val();
		    	    		window.history.pushState("", "", "/search?query=" + query + "&start=0&rows=10&page=1");
	    	    		});
	    	    		
	    	    		clearPager();
	    	    		
	    	    		$('.pagination').each(function(index) {
	    	    			$page = $(this);
	    	    			$list = $('<li>');
	    	    			$anchor = $('<a>');
	    	    			var prevPageNo = data.pager.currentPage - 1;
	    	    			console.log("hasPreviousPage: " + data.pager.hasPreviousPage + " " + prevPageNo);
	    	    			if(data.pager.hasPreviousPage) {
	    	    				$list.addClass('prev');
	    	    				$prev_page = getUrl() + "&page=" + prevPageNo;
	    	    				$anchor.addClass('paging').attr('href', $prev_page);
	    	    				$anchor.attr('id','page-' + prevPageNo);
								$anchor.html('&laquo;');
	            			} else {
	    	    				$list.addClass('prev disabled');
	    	    				$anchor.addClass('paging');
								$anchor.html('&laquo;');
	            			}
	    	    			$list.append($anchor);
	    	    			$page.append($list);
	    	    			
	    	    		    for ( var i = 0; i < data.pager.pagesList.length; i++) {
	    	    		        var index = data.pager.pagesList[i];
		    	    			console.log(index + "-" + data.pager.currentPage);
								if (index == data.pager.currentPage) {
	    							if(index == data.pager.currentPage.getMaxViewablePages) {
	    								$span = $('<span>').addClass('max-viewable-reached hide');
	    							}
	    							$list_loop = $('<li>').addClass('active current').attr('id', 'list-' + index);
	    							$anchor_loop = $('<a>').addClass('paging').attr('id', 'page-' + index).attr('href', '#');
	    							$anchor_loop.html(data.pager.currentPage);
	    							$span_inner = $('<span>').addClass('sr-only').html('(current)');
	    							$anchor_loop.append($span_inner);
	    							$list_loop.append($anchor_loop);
								} else {
									$list_loop = $('<li>').attr('id', 'list-' + index);
									$url = getUrl() + "&page=" + index;
	    							$anchor_loop = $('<a>').addClass('paging').attr('id', 'page-' + index).attr('href', url);
	    							$anchor_loop.html(index);
	    							$list_loop.append($anchor_loop);
								}	    	    				
								$page.append($list_loop);
    	    				}
	    	    			
	    	    			$list = $('<li>');
	    	    			$anchor = $('<a>');
	    	    			var nextPageNo = data.pager.currentPage + 1;
	    	    			console.log("hasNextPage: " + data.pager.hasNextPage + " " + nextPageNo);
	    		        	if(data.pager.hasNextPage && !data.pager.hasMaxViewablePagedReached) {
	    	    				$list.addClass('next');
	    	    				$prev_page = getUrl() + "&page=" + nextPageNo;
	    	    				$anchor.addClass('paging').attr('href', $prev_page);
	    	    				$anchor.attr('id','page-' + nextPageNo);
								$anchor.html('&raquo;');
	            			} else {
	    	    				$list.addClass('next disabled');
	    	    				$anchor.addClass('paging');
								$anchor.html('&raquo;');
	            			}
	    	    			$list.append($anchor);
	    	    			$page.append($list);
	    	    			
		    	    		$('#displayingXOfY').html(data.pager.displayingXOfY);
	    	    		});
							
	    	    		paging();
	    	    		
	    	    		console.log(results);
	    	    		enableForm();
	    	    	},
	    	    	error: function(jqXHR, textStatus, errorThrown) {
	    		    	console.log("error " + jqXHR.status + " " + textStatus + " " + errorThrown);
	    	    	}
	    	    });
			}
		});
	</script>
}

@getName(facetName: String) = @{
	cachedFacets.get(facetName) match {
      case Some(value) => { value.getValue }
      case None => { println("nothing") }
	}
}

@****************************************
* Helper generating navigation links    *
****************************************@
@link(pageNo:Int, newSortBy:String) = @{
    
    var sortBy = currentSortBy
    var order = currentOrder
    
    if(newSortBy != null) {
        sortBy = newSortBy
        if(currentSortBy == newSortBy) {
            if(currentOrder == "asc") {
                order = "desc"
            } else {
                order = "asc"
            }
        } else {
            order = "asc"
        }
    }

    // Generate the link
    routes.Application.search(q.query, pageNo, sortBy, order)
}

@pagination = {
	@if(currentPage.getTotalItems > 0) {
		<div class="text-center paging-tabs">
			<ul class="pagination">
				@if(currentPage.hasPreviousPage) {
	            	<li class="prev">
	            		<a href="@link(currentPage.getCurrentPage-1, null)@(q.responseParameters)" id="page-@(currentPage.getCurrentPage-1)" class="paging">&laquo;</a>
	                </li>
	            } else {
	                <li class="prev disabled">
	                    <a class="paging">&laquo;</a>
	                </li>
	            }
				@for(index <- currentPage.getPagesList) {
					@if(index == currentPage.getCurrentPage) {
						@if(index == currentPage.getMaxViewablePages) {
							<span class="max-viewable-reached hide"></span>
						}
						<li class="active current" id="list-@(index)"><a href="#" class="paging" id="page-@(index)">@(currentPage.getCurrentPage) <span class="sr-only">(current)</span></a></li>
					} else {
						<li id="list-@(index)"><a href="@link(index, null)@(q.responseParameters)" id="page-@(index)" class="paging">@(index)</a></li>
					}
				}
	        	@if(currentPage.hasNextPage && !currentPage.hasMaxViewablePagedReached) {
	                <li class="next" id="list-@(index)">
	                    <a href="@link(currentPage.getCurrentPage+1, null)@(q.responseParameters)" id="page-@(currentPage.getCurrentPage+1)" class="paging">&raquo;</a>
	                </li>
	            } else {
	                <li class="next disabled">
	                    <a class="paging">&raquo;</a>
	                </li>
				}
			</ul>
		</div>
	}
}

@main(title, styles, scripts) {

	<ul class="nav nav-tabs">
		<li class="active"><a href="#">Search</a></li>
		<li><a href="@routes.Application.advanced_search()">Advanced Search</a></li>
		<li><a href="@routes.Application.browse()">Browse Collections</a></li>
	</ul>

	<div class="padding-20">
		@helper.form(action=routes.Application.search()) {
	
			<div class="row">
				<div class="col-md-4 col-sm-4">
					<div class="panel panel-default">
						<input id="facet-sort" class="hide" type="checkbox" name="facet.sort" value="@(q.getFacetSortValue("facet.sort"))" @(q.getCheckedFacet("facet.sort")) />
						<input type="hidden" name="page" value="@(currentPage.getCurrentPage)" />
						<div class="padding-5 pull-right">
							<a id="facet-sort-value" class="facet-sort" href=""><span class="label label-primary">value</span></a>
							<a id="facet-sort-count" class="facet-sort" href=""><span class="label label-primary">count</span></a> 
						</div>
						@if(q.res.getFacetFields() != null) {
							@for((fc, index) <- q.res.getFacetFields().zipWithIndex) {
								<div class="panel-body">
				    				<div>
			        					<a><strong>@getName(fc.getName())</strong></a> <span class="badge">@(fc.getValueCount())</span>
			        					<input type="hidden" name="facet.fields" value="@(fc.getName())" id="@(fc.getName())">
			        					<button class="btn btn-primary btn-xs facet-remove" type="button" name="action" value="remove-facet">
			        						<span class="glyphicon glyphicon-remove"></span>
			        					</button>
				    				</div>
				    				<div class="facet-index">
			      						<ul class="list-unstyled">
											@for((f, i) <- fc.getValues().zipWithIndex) {
												@if(i >= facetLimit) {
			        								<li class="facet-options hide">
												} else {
			        								<li class="facet-options show" data-attr="default">
												}
			        								<a class="facet include" href="" title="Include" id="include_@(fc.getName())"><span class="glyphicon glyphicon-plus-sign facet-deselected"></span></a>
			        								<a class="facet exclude" href="" title="Exclude" id="exclude_@(fc.getName())"><span class="glyphicon glyphicon-minus-sign facet-deselected"></span></a>
			          								<a href="@(routes.Application.search(q.query))@(q.getParamsPlusFilter(fc.getName(),f.getName()))">@(Html(q.formatFacet(fc,f))) <span class="badge">@(f.getCount())</span></a>
			          								<input class="include hide" type="checkbox" name="facet.in.@(fc.getName())" value='"@(f.getName())"' @(q.getCheckedInString(fc.getName(),f.getName())) onclick="this.form.submit();"/>
			          								<input class="exclude hide" type="checkbox" name="facet.out.@(fc.getName())" value='"@(f.getName())"' @(q.getCheckedOutString(fc.getName(),f.getName())) onclick="this.form.submit();"/>
												</li>
										        <!-- dynamically add checked="true"? -->
										        <!-- OR use some kind of link constructor? -->
											}
											@if((fc.getValues().size - facetLimit) > 0) {
												<li> 
		        									<a id="@(fc.getName())" class="show-more" href="#"><span class="glyphicon glyphicon-plus-sign"></span> <span>Show more...</span></a>
		        								</li>
	        								}
											<li>
	        									<button class="btn btn-primary btn-xs add-more-button" type="button"><span id="add-more-button-text-@(index)">Add</span> <span class="glyphicon glyphicon-plus"></span></button>
											</li>
											
			    						</ul>
										<div id="add-more-option-@(index)" class="input-group input-group-sm hide">
											<span class="input-group-btn">
	        									<button class="add-facet-button btn btn-default" type="button"><span class="glyphicon glyphicon-search"></span></button>
	      									</span>
											<input type="text" class="form-control add-facet-field" placeholder="Facet Search" value="" >
											<span class="input-group-sm input-group-addon">
												<a href="#" title="Include" class="add-facet-value">
													<span class="glyphicon glyphicon-plus-sign"></span>
												</a>&nbsp;
												<a href="#" title="Exclude" class="remove-facet-value">
													<span class="glyphicon glyphicon-minus-sign"></span>
												</a>
											</span>
											<span class="tt-dropdown-menu" style="position: absolute; top: 100%; left: 0px; z-index: 100; display: none; right: auto;">
											</span>
	
										</div>
				    				</div>
				  				</div>
							}
						}
						<div class="panel-body">
							<button class="btn btn-primary btn-xs" type="submit" name="action" value="reset-facets"><span>Reset Facets</span> <span class="glyphicon glyphicon-remove-circle"></span></button>
							@if(optionalFacets.size >= 1) {
								<span class="input-group pull-right">
									<button class="btn btn-primary btn-xs" type="submit" name="action" value="add-facet"><span>Add Facet</span></button>
									<div class="btn-group">
	  									<div class="form-group">
											<select class="form-control" name="selected.facet" id="facet-values">
												@for((key, value) <- optionalFacets) {
													<option value="@key">@value.getValue()</option>
												}
											</select>
										</div>
									</div>
								</span>
							}
						</div>
						
					</div>
				</div>
		
				<div class="col-md-8 col-sm-8">
					<div class="panel panel-default">
						<div class="panel-body">
				   			<div class="input-group">
								<input type="text" class="form-control search-field" name="query" value="@(q.query)" id="query" placeholder="Enter search term" />
								<span class="input-group-btn">
									<button type="button" class="btn btn-primary" id="search" name="action" value="search">Search</button>
									<button type="reset" class="btn btn-primary" id="reset" name="action" value="reset">Reset</button>
									<img id="ajax-loader" src="assets/images/ajax-loader.gif">
								</span>
							</div>
						</div>
					</div>
					
					<div class="padding-20 hide" id="max-view-reached">
						<div class="alert alert-danger alert-dismissable">
							<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
							Maximum number of results reached
						</div>
					</div>
								
					<div class="panel panel-default">
						<div class="panel-heading filter-heading">
                            <h4 class="panel-title pull-left filter-heading-title">
                                Results <span id="displayingXOfY">@currentPage.getDisplayXtoYofZ(" to "," of ")</span>
                            </h4>
                            <div class="form-inline pull-right">
								<div class="form-group">
									<select class="form-control" name="sort" id="sort">
										<!-- get from some where -->
										<option value="content_type_norm">Title</option>
										<option value="crawl_date">Crawl Date</option>
										<option value="content_type_norm">Content</option>
										<option value="domain">Domain</option>
										<option value="sentiment_score">Score</option>
									</select>
								</div>
								<div class="form-group">
									<select class="form-control" name="order" id="order">
										<option value="asc">Asc</option>
										<option value="desc">Desc</option>
									</select>
								</div>
							</div>
						</div>

						<div class="panel-body">
							@pagination
	
							<div id="result-set">
								@for((d, index) <- q.res.getResults().zipWithIndex) {
									<div class="list-group">
										<span class="list-group-item" href="#">
											<h4 class="list-group-item-heading">@(currentPage.getNextIndex(index)) <a href="http://web.archive.org/web/@(d.getFirstValue("wayback_date"))/@(d.getFirstValue("url"))">"@d.getFirstValue("title")"</a></h4>
											<p class="list-group-item-text">
													@d.getFirstValue("crawl_date")<br />
													@d.getFirstValue("content_type_norm")<br />
													@d.getFirstValue("domain")<br />
													@d.getFirstValue("sentiment_score")
											</p>
										</span>
									</div>
								}
							</div>
							@pagination
						</div>
					</div>

				</div>
			</div>
		}
	</div>
}
