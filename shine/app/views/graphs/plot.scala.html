@(title: String, user: User, q: String, labelX: String, labelY: String, year_start: String, year_end: String, graphMap:scala.collection.immutable.Map[uk.bl.wa.shine.Query,scala.collection.immutable.Map[String,scala.collection.mutable.ListBuffer[uk.bl.wa.shine.GraphData]]], pageName: String)

@styles = {
}

@scripts = {
	<script src="@routes.Assets.at("javascripts/search.js")" type="text/javascript"></script>
    <script src="@routes.Assets.at("javascripts/d3.v3.4.8.min.js")" type="text/javascript"></script>
    <script src="@routes.Assets.at("javascripts/dimple.v2.1.3.min.js")" type="text/javascript"></script>
    
	
	<script type="text/javascript">
	
		$(document).ready(function(){

			
			$('#update').on('click', function() {
				$('form').submit();
				//processChart();
			});
		
			$('#ajax-loader').hide();

			function disableForm() {
				$('#ajax-loader').show();
				$('#query').attr('disabled', 'disabled');
				$('#year-start').attr('disabled', 'disabled');
				$('#year-end').attr('disabled', 'disabled');
				$('#update').attr('disabled', 'disabled');
				$('#reset').attr('disabled', 'disabled');
			}
			
			function enableForm() {
				$('#ajax-loader').hide();
				$('#query').removeAttr('disabled');
				$('#year-start').removeAttr('disabled');
				$('#year-end').removeAttr('disabled');
				$('#update').removeAttr('disabled');
				$('#reset').removeAttr('disabled');
			}
			
			$("#year-start").val(@(year_start));
			$("#year-end").val(@(year_end));
			
    var svg = dimple.newSvg("#chartContainer", "100%", 300);
    disableForm();
    d3.tsv("@routes.Shiner.trendsTsv(q,year_start,year_end)", function (data) {
	  enableForm();
      var myChart = new dimple.chart(svg, data);
      myChart.setMargins("100px", "30px", "60px", "60px");
      var x = myChart.addCategoryAxis("x", "Date");
      x.addOrderRule("Date");
      myChart.addMeasureAxis("y", "Percentage");
      var s = myChart.addSeries("Query", dimple.plot.line);
      s.getTooltipText = function (e) {
          // Load the sample results:
          $.getJSON('@{routes.Shiner.sampleFromRange()}' + '?query=' + e.aggField[0] + '&year=' + e.x, function(data) {
        	 $("#samplesTable tr.sample-row").remove();
        	 $.each(data, function( index, value ) {
        	     if( value.matches.length > 0 ) {
		        	 $("#samplesTable").append("<tr class='sample-row'><td class='fragment-left'><span class='fragment-left-inner'>"+value.matches[0][0]+"</span></td><td class='fragment-match'><a href='http://web.archive.org/web/"+value.wayback_date+"/"+value.url+"'>"+value.matches[0][1]+"</a></td><td class='fragment-right'>"+value.matches[0][2]+"</td></tr>");
		         }
	         });
  		  });
          // And return the tool-tip
          return [
              "\"" + e.aggField[0] + "\"",
              e.yValue.toPrecision(4) + "% of resources", "crawled in " + e.x
          ];
      };
      s.interpolation = "step";
      //s.lineWeight = 1;
      myChart.addLegend(100, 10, "100%", 100, "left");
      myChart.draw();
      
    // Add a method to draw the chart on resize of the window
	window.onresize = function () {
    	// As of 1.1.0 the second parameter here allows you to draw
    	// without reprocessing data.  This saves a lot on performance
    	// when you know the data won't have changed.
    	myChart.draw(0, true);
	};
			
      
    });
    
		});
	</script>
}

@main(title, scripts, styles, user, pageName) {

	<!-- Tab panes -->
	<div class="tab-content">
  		<div class="tab-pane active" id="plot">
			<div id="graph-container">
				@helper.form(action=routes.Search.plot_graph()) {
					<div class="row padding-5 text-center">
						<div class="col-md-4">
							<input type="text" class="form-control" name="query" placeholder="Comma separated terms" value="@(q)" id="query" />
						</div>
						<div class="col-md-8">
							<div class="form-inline">
							    <!-- 
							    <div class="form-group">
									<input type="radio" name="interval" value="3month"> <label>3 Month</label>
									<input type="radio" name="interval" value="6month"> <label>6 Month</label>
									<input type="radio" name="interval" value="1year"> <label>1 Year</label>
								</div>							
							     -->
								<div class="form-group">
									<label class="sr-only" for="from-date">From:</label>
									<input type="text" class="form-control field-right" id="year-start" name="year_start">
								</div>
								<div class="form-group">
									<label class="sr-only" for="to-date">To:</label>
									<input type="text" class="form-control field-right" id="year-end" name="year_end">
								</div>
								<button type="submit" class="btn btn-primary" id="update" name="action" value="update">Update Graph</button>
								<button type="reset" class="btn btn-primary button-reset" id="reset" name="action" value="reset">Reset All</button>
								<img id="ajax-loader" src="assets/images/ajax-loader.gif">
							</div>
						</div>
					</div>
			    }
		    	
			<div id="chartContainer">
			</div>
		    	
			</div>
			<table id="samplesTable" class="table table-striped">
			</table>
		</div>
  	</div>

}
