@(title: String, user: User, q: String, labelX: String, labelY: String, year_start: String, year_end: String, graphMap:scala.collection.immutable.Map[uk.bl.wa.shine.Query,scala.collection.immutable.Map[String,scala.collection.mutable.ListBuffer[uk.bl.wa.shine.GraphData]]], pageName: String)

@styles = {
	<link rel="stylesheet" type="text/css" href="@routes.Assets.at("jqplot/jquery.jqplot.min.css")">
}

@scripts = {
	<!--[if lt IE 9]><script src="@routes.Assets.at("javascripts/jqplot/excanvas.min.js")" type="text/javascript"></script><![endif]-->
	<script src="@routes.Assets.at("jqplot/jquery.jqplot.min.js")" type="text/javascript"></script>
	<script src="@routes.Assets.at("jqplot/plugins/jqplot.canvasTextRenderer.min.js")" type="text/javascript"></script>
	<script src="@routes.Assets.at("jqplot/plugins/jqplot.canvasAxisTickRenderer.min.js")" type="text/javascript"></script>
	<script src="@routes.Assets.at("jqplot/plugins/jqplot.canvasAxisLabelRenderer.min.js")" type="text/javascript"></script>
	<script src="@routes.Assets.at("jqplot/plugins/jqplot.cursor.min.js")" type="text/javascript"></script>
	<script src="@routes.Assets.at("jqplot/plugins/jqplot.highlighter.min.js")" type="text/javascript"></script>
	<script src="@routes.Assets.at("javascripts/search.js")" type="text/javascript"></script>
	
	<script type="text/javascript">
	
		$(document).ready(function(){

			
			$('#query').keypress(function(event){
				var keycode = (event.keyCode ? event.keyCode : event.which);
				if(keycode == '13'){
				    processChart();
				}
			});

			$('#year-start').keypress(function(event){
				var keycode = (event.keyCode ? event.keyCode : event.which);
				if(keycode == '13'){
				    processChart();
				}
			});

			$('#year-end').keypress(function(event){
				var keycode = (event.keyCode ? event.keyCode : event.which);
				if(keycode == '13'){
				    processChart();
				}
			});

			$('#update').on('click', function() {
				$('form').submit();
				//processChart();
			});
		
			$('#ajax-loader').hide();

			function disableForm() {
				$('#ajax-loader').show();
				$('#query').attr('disabled', 'disabled');
				$('#year-start').attr('disabled', 'disabled');
				$('#year-end').attr('disabled', 'disabled');
				$('#update').attr('disabled', 'disabled');
				$('#reset').attr('disabled', 'disabled');
			}
			
			function enableForm() {
				$('#ajax-loader').hide();
				$('#query').removeAttr('disabled');
				$('#year-start').removeAttr('disabled');
				$('#year-end').removeAttr('disabled');
				$('#update').removeAttr('disabled');
				$('#reset').removeAttr('disabled');
			}
			
			function processChart() {
				disableForm();
				var query = $("#query").val();
				var year_start = $("#year-start").val();
				var year_end = $("#year-end").val();
				
				$("input[name='interval']").each(function() {
					var value = $(this).val();
					console.log("interval: " + value);
				});

				var url = "processChart?query=" + query + "&year_start=" + year_start + "&year_end=" + year_end;

				//	[{"query":"nhs","data":[{"value":"1994","count":3},{"value":"1995","count":1},{"value":"1996","count":439},{"value":"1997","count":2529},{"value":"1998","count":2792},{"value":"1999","count":7345},{"value":"2000","count":9946},{"value":"2001","count":36838},{"value":"2002","count":97371},{"value":"2003","count":236514},{"value":"2004","count":277319},{"value":"2005","count":207931}]},{"query":" wikipedia","data":[{"value":"2001","count":12},{"value":"2002","count":67},{"value":"2003","count":464},{"value":"2004","count":8030},{"value":"2005","count":64540}]}]
				$.ajax({
	    	    	url: url,
	    	    	dataType: 'json',
	    	    	success: function(data) {
	    	    		var graphPoints = [];
	    	    		$.each( data, function( index, obj ) {
		    	    		var results = [];
		    	    		$.each( obj.data, function( index, value) {
//			    	    		console.log(">>> : " + value.value + " " + value.count);
			    	    		results.push([value.value, value.count, obj.query]);
		    	    		});
		    	    		graphPoints.push(results)
	    	    		});
	    		    	var start = parseInt($("#year-start").val())-1;
	    	    		var end = parseInt($("#year-end").val())+1;
	    	    		
	    				runGraph(graphPoints, start, end);
	    				enableForm();
	    	    	},
	    	    	error: function(jqXHR, textStatus, errorThrown) {
	    		    	console.log("error " + jqXHR.status + " " + textStatus + " " + errorThrown);
	    	    	}
	    	    });
			}
			
			
			function initialGraphLoad() {
				// each key has a tab/page
				// also need to set chartgraph id to key
				var points = [];
				
				@if(graphMap != null) {
					@for(((search, map), index) <- graphMap.zipWithIndex) {
						var array@(index) = [];
						@for((key, data) <- map) {
							//console.log("k d: @key @data");
							var @key = [];
							@data.map { graphData =>
								array@(index).push(["@(graphData.getValue)", @(graphData.getCount), "@(search.query)"]);
							}
						}
						points.push(array@(index));
					}
				}
	
				runGraph(points, @(year_start), @(year_end));
			}
			
			initialGraphLoad();
			
			function runGraph(points, start, end) {
				// Some simple loops to build up data arrays.
	    		console.log("x axis: " + start + " " + end + " p:" + points.length);

				var plotter = $.jqplot('chart-search', points, {
					
				    title:'Ngram',
					axes:{
				        xaxis:{
				            renderer:$.jqplot.DateAxisRenderer,
				            min: start,
				            max: end,
                            autoscale:true,
                            tickOptions:{
                                formatString:'%d'
                            }, 
	                        label:'@(labelX)'
						},
						yaxis:{
                            min: 0,
	                        autoscale:true,
	                        tickOptions:{
	                            formatString:'%d'
	                        }, 
							label:'@(labelY)'
						}
					},
				    highlighter: {
						show: true,
						sizeAdjust: 7.5,
						yvalues: 4,
						formatString: '<h2>%d (%d) %s</h2>'
			        },
					cursor:{ 
					   	show: true,
						zoom: false, 
						showTooltip: false
					}
					
				}).replot();
				
		        $('#chart-search').on('jqplotDataClick', 
	                function (ev, seriesIndex, pointIndex, data) {
	        			var year = data[0];
	        			var count = data[1];
	        			var query = data[2];
	        			var url = "search?facet.fields=crawl_year&facet.in.crawl_year=\"" + year + "\"&query=" + query + "&action=search&sort=content_type_norm&order=asc&facet.show=crawl_year";
	        			window.location.href = url;
	                }
	            );
		        
		        $('#chart-search').on('jqplotDataMouseOver', function (ev, seriesIndex, pointIndex, data, radius) {
		        	$('.jqplot-event-canvas').css( 'cursor', 'pointer' );
		       	});
		        
		        $('#chart-search').on('jqplotDataUnhighlight', function() {
		            $('.jqplot-event-canvas').css('cursor', 'auto');
		        });
		        
				$('.button-reset').on('click', function() {
					//plotter.resetZoom(); 
					console.log("reset");
				});
			}
			
			$("#year-start").val(@(year_start));
			$("#year-end").val(@(year_end));
		});
	</script>
}

@main(title, scripts, styles, user, pageName) {

	<!-- Tab panes -->
	<div class="tab-content">
  		<div class="tab-pane active" id="plot">
			<div class="padding-20" id="graph-container">
				@helper.form(action=routes.Search.plot_graph()) {
					<div class="row padding-10">
						<div class="col-md-12 text-center">
							<input type="text" class="form-control" name="query" placeholder="Comma separated terms" value="@(q)" id="query" />
						</div>
					</div>
					<div class="row padding-10 text-center">
						<div class="col-md-12">
							<div class="form-inline">
							    <div class="form-group">
									<input type="radio" name="interval" value="3month"> <label>3 Month</label>
									<input type="radio" name="interval" value="6month"> <label>6 Month</label>
									<input type="radio" name="interval" value="1year"> <label>1 Year</label>
								</div>							
								<div class="form-group">
									<label class="sr-only" for="from-date">From:</label>
									<input type="text" class="form-control field-right" id="year-start" name="year_start">
								</div>
								<div class="form-group">
									<label class="sr-only" for="to-date">To:</label>
									<input type="text" class="form-control field-right" id="year-end" name="year_end">
								</div>
								<button type="button" class="btn btn-primary" id="update" name="action" value="update">Update Graph</button>
								<button type="reset" class="btn btn-primary button-reset" id="reset" name="action" value="reset">Reset All</button>
								<img id="ajax-loader" src="assets/images/ajax-loader.gif">
							</div>
						</div>
					</div>
			    }
		    	<div id="chart-search"></div>
			</div>
		</div>
  	</div>

}
